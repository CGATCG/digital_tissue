<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grid Layer Editor</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="topbar__titleWrap">
          <div class="topbar__title">Grid Layer Editor</div>
          <div id="currentFileInfo" class="topbar__fileInfo"></div>
        </div>
        <div class="topbar__actions">
          <button id="newBtn" class="btn btn--secondary">New</button>
          <button id="openBtn" class="btn btn--secondary">Open</button>
          <button id="deleteBtn" class="btn btn--secondary">Delete</button>
          <label class="btn btn--secondary">
            Import
            <input id="fileInput" type="file" accept="application/json" hidden />
          </label>
          <button id="saveBtn" class="btn btn--primary">Save</button>
          <button id="saveAsBtn" class="btn btn--secondary">Save As</button>
          <button id="downloadBtn" class="btn btn--secondary">Download</button>
          <button id="demoBtn" class="btn btn--secondary">Demo</button>
        </div>
      </header>

      <div class="content">
        <div class="workspace">
          <div class="screenTabs">
            <button class="screenBtn screenBtn--active" data-screen="workspace">Workspace</button>
            <button class="screenBtn" data-screen="manage">Manage</button>
            <button class="screenBtn" data-screen="assign">Assign values</button>
            <button class="screenBtn" data-screen="functions">Functions</button>
            <button class="screenBtn" data-screen="runtime">Runtime</button>
            <button class="screenBtn" data-screen="evolution">Evolution</button>
          </div>

          <div class="screenPanel screenPanel--active" data-screen="workspace">
            <main class="main">
              <div id="activeLayerBar" class="activeBar">
                <div class="activeBar__left">
                  <div id="activeLayerTitle" class="activeBar__title"></div>
                  <div id="activeLayerStats" class="activeBar__meta"></div>
                </div>
                <div class="activeBar__right">
                  <select id="layerSelect" class="input input--tiny"></select>
                  <input id="activeLayerColor" class="input input--tiny" type="color" />
                </div>
              </div>

              <div id="canvasWrap" class="canvasWrap">
                <canvas id="canvas" class="canvas"></canvas>
                <canvas id="overlay" class="overlay"></canvas>
              </div>
            </main>

            <aside class="toolsDock">
              <div class="toolsBody">
                <div class="workspaceToolsStack">
                  <section class="panel">
                    <div class="panel__title">Paint (categorical)</div>
                    <div class="row">
                      <label class="label">Paint layer</label>
                      <select id="paintLayerSelect" class="input"></select>
                    </div>
                    <div class="row">
                      <label class="label">Mode</label>
                      <select id="editMode" class="input">
                        <option value="brush">brush</option>
                        <option value="rectangle">rectangle</option>
                        <option value="clone">clone (copy pixel)</option>
                      </select>
                    </div>
                    <div class="row">
                      <div id="paintCloneInfo" class="meta"></div>
                    </div>
                    <div class="row">
                      <label class="label">Value</label>
                      <input id="paintValue" class="input" type="number" value="1" step="1" />
                    </div>
                    <div class="row">
                      <label class="label">Radius</label>
                      <input id="brushRadius" class="input" type="range" min="0" max="25" value="2" />
                    </div>
                    <div class="row row--inline">
                      <label class="checkbox"><input id="toggleEraser" type="checkbox" /> Eraser (set 0)</label>
                    </div>

                    <div class="hr"></div>
                    <div class="row row--inline">
                      <label class="checkbox"><input id="paintOverlayEnabled" type="checkbox" checked /> Show paint layer overlay</label>
                    </div>
                    <div class="row">
                      <label class="label">Overlay opacity</label>
                      <input id="paintOverlayAlpha" class="input" type="range" min="0" max="1" step="0.05" value="0.45" />
                    </div>
                  </section>

                  <section class="panel">
                    <div class="panel__title">Inspect</div>
                    <div class="row row--inline">
                      <div id="cursorInfo" class="meta">(y,x): –</div>
                    </div>

                    <div class="inspectLayout">
                      <div class="inspectLayout__left">
                        <div class="row">
                          <label class="label">Mode</label>
                          <select id="inspectMode" class="input">
                            <option value="summary" selected>Layer summary</option>
                            <option value="cursor">Cursor table (all layers)</option>
                          </select>
                        </div>

                        <div class="row row--inline">
                          <div class="runtimeBlock__controls">
                            <label class="meta">Mask</label>
                            <select id="inspectHistMaskLayer" class="input input--tiny">
                              <option value="">(none)</option>
                            </select>
                            <select id="inspectHistMaskOp" class="input input--tiny">
                              <option value="==">==</option>
                              <option value="!=">!=</option>
                              <option value=">">></option>
                              <option value=">=">>=</option>
                              <option value="<"><</option>
                              <option value="<="><=</option>
                            </select>
                            <input id="inspectHistMaskValue" class="input input--tiny" type="number" step="any" value="1" />
                          </div>
                        </div>

                        <div class="row row--inline">
                          <div id="inspectCursorValue" class="meta"></div>
                        </div>
                        <div class="row row--inline">
                          <div id="inspectTable" class="table"></div>
                        </div>
                      </div>

                      <div class="inspectLayout__right">
                        <div class="row row--inline">
                          <div id="inspectSummaryStats" class="meta" style="font-size: 11px; line-height: 1.4;"></div>
                        </div>
                        <div class="row row--inline">
                          <canvas id="inspectCanvasHist" class="inspectHistCanvas"></canvas>
                        </div>
                      </div>
                    </div>
                  </section>

                  <section class="panel">
                    <div class="panel__title">Grid</div>
                    <div class="row">
                      <label class="label">H</label>
                      <input id="HInput" class="input" type="number" min="4" max="512" value="64" />
                    </div>
                    <div class="row">
                      <label class="label">W</label>
                      <input id="WInput" class="input" type="number" min="4" max="512" value="96" />
                    </div>
                    <div class="row">
                      <label class="label">Zoom</label>
                      <input id="zoomInput" class="input" type="range" min="1" max="24" value="8" />
                    </div>
                    <div class="row row--inline">
                      <label class="checkbox"><input id="autoFitZoom" type="checkbox" checked /> Auto-fit zoom</label>
                    </div>
                    <div class="row row--inline">
                      <label class="checkbox"><input id="gridLinesInput" type="checkbox" checked /> Grid lines</label>
                    </div>
                  </section>
                </div>
              </div>
            </aside>
          </div>

          <div class="screenPanel" data-screen="manage">
            <div class="manageLayout">
              <aside class="sidebar">
                <section class="panel">
                  <div class="panel__title">Layers</div>
                  <div class="row">
                    <label class="label">Search</label>
                    <input id="layerSearchInput" class="input" placeholder="filter layers…" />
                  </div>
                  <div class="row row--inlineFlex">
                    <label class="checkbox"><input id="groupByPrefix" type="checkbox" checked /> Group by prefix</label>
                    <div class="spacer"></div>
                    <button id="collapseAllBtn" class="btn btn--secondary btn--tiny">Collapse</button>
                    <button id="expandAllBtn" class="btn btn--secondary btn--tiny">Expand</button>
                  </div>
                  <div class="row row--inlineFlex">
                    <button id="bulkDeleteBtn" class="btn btn--danger btn--tiny">Delete selected</button>
                    <div class="spacer"></div>
                    <div id="bulkDeleteInfo" class="meta"></div>
                  </div>
                  <div class="row row--inline">
                    <div id="layersTable" class="table"></div>
                  </div>
                </section>
              </aside>

              <aside class="toolsDock toolsDock--full">
                <div class="tabs">
                  <button class="tabBtn tabBtn--active" data-tab="generate">Generate</button>
                </div>

                <div class="toolsBody">
                <div class="tabPanel tabPanel--active" data-tab="generate">
                  <section class="panel">
                    <div class="panel__title">Bulk add layers (masked)</div>
                    <div class="help">Create many layers like <span class="mono">prefix1…prefixN</span> and optionally keep only cells where a mask condition is true.</div>

                    <div class="row">
                      <label class="label">Name prefix</label>
                      <input id="bulkPrefix" class="input" value="protein_" />
                    </div>
                    <div class="row">
                      <label class="label">Start #</label>
                      <input id="bulkStart" class="input" type="number" value="1" step="1" />
                    </div>
                    <div class="row">
                      <label class="label">How many</label>
                      <input id="bulkCount" class="input" type="number" value="100" step="1" min="1" max="10000" />
                    </div>

                    <div class="row">
                      <label class="label">If exists</label>
                      <select id="bulkCollision" class="input">
                        <option value="error">error</option>
                        <option value="skip">skip</option>
                        <option value="overwrite">overwrite</option>
                      </select>
                    </div>

                    <div class="row">
                      <div id="bulkAddPreview" class="meta"></div>
                    </div>

                    <div class="hr"></div>

                    <div class="row">
                      <label class="label">Kind</label>
                      <select id="bulkKind" class="input">
                        <option value="counts">counts</option>
                        <option value="continuous">continuous</option>
                        <option value="categorical">categorical</option>
                      </select>
                    </div>
                    <div class="row">
                      <label class="label">Initialize</label>
                      <select id="bulkInit" class="input">
                        <option value="zeros">zeros</option>
                        <option value="constant">constant</option>
                        <option value="random">random</option>
                        <option value="gradient">gradient</option>
                      </select>
                    </div>

                    <details class="details">
                      <summary class="details__summary">Advanced</summary>
                      <div class="row">
                        <label class="label">Value</label>
                        <input id="bulkValue" class="input" type="number" value="1" step="0.1" />
                      </div>
                      <div class="row">
                        <label class="label">Seed</label>
                        <input id="bulkSeed" class="input" type="number" value="0" step="1" />
                      </div>
                    </details>

                    <div class="hr"></div>

                    <div class="row">
                      <label class="label">Mask layer</label>
                      <select id="maskLayer" class="input"></select>
                    </div>
                    <div class="row">
                      <label class="label">Condition</label>
                      <div class="two">
                        <select id="maskOp" class="input">
                          <option value="==">==</option>
                          <option value="!=">!=</option>
                          <option value=">">&gt;</option>
                          <option value=">=">&gt;=</option>
                          <option value="<">&lt;</option>
                          <option value="<=">&lt;=</option>
                        </select>
                        <input id="maskValue" class="input" type="number" value="1" step="1" />
                      </div>
                    </div>
                    <div class="row row--inline">
                      <label class="checkbox"><input id="maskInvert" type="checkbox" /> Invert mask</label>
                    </div>

                    <div class="row">
                      <button id="bulkAddBtn" class="btn btn--primary btn--full">Bulk add</button>
                    </div>
                  </section>

                  <section class="panel">
                    <div class="panel__title">Derived / patterned layers</div>
                    <div class="help">Create one new layer per matching source layer. Use <span class="mono">{suffix}</span> in the template to reuse the matched suffix.</div>

                    <div class="row row--inline">
                      <button id="derivedPresetGeneFromMolecule" class="btn btn--secondary btn--full">Preset: molecule_* → gene_{suffix}</button>
                    </div>

                    <div class="row">
                      <label class="label">Match prefix</label>
                      <input id="derivedSourcePrefix" class="input" value="molecule_" />
                    </div>
                    <div class="row">
                      <label class="label">Create as</label>
                      <input id="derivedTargetTemplate" class="input" value="gene_{suffix}" />
                    </div>

                    <div class="row">
                      <div id="derivedPreview" class="meta"></div>
                    </div>

                    <details class="details">
                      <summary class="details__summary">Advanced</summary>
                      <div class="row">
                        <label class="label">Kind/color from</label>
                        <select id="derivedMetaFrom" class="input">
                          <option value="source">source layer</option>
                          <option value="prototype">prototype layer</option>
                        </select>
                      </div>
                      <div class="row">
                        <label class="label">Prototype</label>
                        <select id="derivedPrototypeLayer" class="input"></select>
                      </div>
                      <div class="row">
                        <label class="label">Data init</label>
                        <select id="derivedDataInit" class="input">
                          <option value="zeros">zeros</option>
                          <option value="copy_source">copy source</option>
                          <option value="copy_prototype">copy prototype</option>
                        </select>
                      </div>
                      <div class="row row--inline">
                        <label class="checkbox"><input id="derivedSkipExisting" type="checkbox" checked /> Skip if target exists</label>
                      </div>
                    </details>
                    <div class="row">
                      <button id="derivedApplyBtn" class="btn btn--primary btn--full">Create derived layers</button>
                    </div>
                  </section>
                </div>

              </div>
              </aside>
            </div>
          </div>

          <div class="screenPanel" data-screen="assign">
            <div class="assignLayout">
              <aside class="sidebar">
                <section class="panel">
                  <div class="panel__title">Targets</div>
                  <div class="help">Pick layers to change.</div>
                  <div class="row">
                    <label class="label">Search</label>
                    <input id="opTargetFilter" class="input" placeholder="filter targets… (use * as wildcard)" />
                  </div>
                  <div class="row row--inline">
                    <div class="two">
                      <button id="opTargetsSelectAll" class="btn btn--secondary btn--full">Select all visible</button>
                      <button id="opTargetsClear" class="btn btn--secondary btn--full">Clear</button>
                    </div>
                  </div>
                  <div class="row row--inline">
                    <div id="opTargetsList" class="targetsList"></div>
                  </div>
                </section>
              </aside>

              <aside class="toolsDock toolsDock--full">
                <div class="toolsBody">
                  <section class="panel">
                    <div class="panel__title">Assign values (masked)</div>

                    <div class="row">
                      <label class="label">Operation</label>
                      <select id="opType" class="input">
                        <option value="set_constant">set constant</option>
                        <option value="set_random_uniform">set random uniform</option>
                        <option value="add_random_uniform">add random uniform</option>
                      </select>
                    </div>
                    <div class="row">
                      <label class="label">Value</label>
                      <input id="opValue" class="input" type="number" value="1" step="0.1" />
                    </div>
                    <div class="row">
                      <label class="label">Min / Max</label>
                      <div class="two two--equal">
                        <input id="opMin" class="input" type="number" value="0" step="0.1" />
                        <input id="opMax" class="input" type="number" value="1" step="0.1" />
                      </div>
                    </div>
                    <div class="row">
                      <label class="label">Seed</label>
                      <input id="opSeed" class="input" type="number" value="0" step="1" />
                    </div>

                    <div class="hr"></div>

                    <div class="row">
                      <label class="label">Mask layer</label>
                      <select id="opMaskLayer" class="input"></select>
                    </div>
                    <div class="row">
                      <label class="label">Condition</label>
                      <div class="two">
                        <select id="opMaskOp" class="input">
                          <option value="==">==</option>
                          <option value="!=">!=</option>
                          <option value=">">&gt;</option>
                          <option value=">=">&gt;=</option>
                          <option value="<">&lt;</option>
                          <option value="<=">&lt;=</option>
                        </select>
                        <input id="opMaskValue" class="input" type="number" value="1" step="1" />
                      </div>
                    </div>
                    <div class="row row--inline">
                      <label class="checkbox"><input id="opMaskInvert" type="checkbox" /> Invert mask</label>
                    </div>
                    <div class="row row--inline">
                      <div id="opMaskPreview" class="meta"></div>
                    </div>

                    <div class="row">
                      <button id="opApplyBtn" class="btn btn--primary btn--full">Apply to targets</button>
                    </div>
                  </section>
                </div>
              </aside>
            </div>
          </div>

          <div class="screenPanel" data-screen="functions">
            <div class="functionsLayout">
              <aside class="toolsDock toolsDock--full">
                <div class="tabs">
                  <button class="tabBtn tabBtn--active" data-tab="measurements">Measurements</button>
                  <button class="tabBtn" data-tab="layerOps">Layer Ops</button>
                </div>

                <div class="toolsBody">
                  <div class="tabPanel tabPanel--active" data-tab="measurements">
                    <section class="panel">
                      <div class="panel__title">Measurements</div>
                      <div class="help">
                        Define scalar outputs using formulas over layers (spreadsheet-style). These are stored inside gridstate.json and used by the Python CLI.
                        Use reductions like <span class="mono">mean(x)</span>, <span class="mono">sum(x)</span>, <span class="mono">median(x)</span>, <span class="mono">quantile(x, 0.9)</span>, and optional filters like <span class="mono">where=(circulation==1)</span>.
                      </div>

                      <div class="row">
                        <label class="label">Insert layer</label>
                        <div class="two two--btn">
                          <select id="fnInsertLayer" class="input"></select>
                          <button id="fnInsertLayerBtn" class="btn btn--secondary">Insert</button>
                        </div>
                      </div>

                      <div class="row">
                        <label class="label">Insert function</label>
                        <div class="two two--btn">
                          <select id="fnInsertFn" class="input"></select>
                          <button id="fnInsertFnBtn" class="btn btn--secondary">Insert</button>
                        </div>
                      </div>

                      <div class="hr"></div>

                      <div class="row row--inline">
                        <div class="two two--equal">
                          <button id="fnAddRowBtn" class="btn btn--secondary">Add measurement</button>
                        </div>
                      </div>

                      <div class="row row--inline">
                        <div id="fnSpecsTable" class="table"></div>
                      </div>
                    </section>
                  </div>

                  <div class="tabPanel" data-tab="layerOps">
                    <section class="panel">
                      <div class="panel__titleRow">
                        <div class="panel__title">Layer Ops</div>
                        <button id="opsHelpBtn" class="btn btn--secondary btn--tiny" type="button" aria-label="Layer Ops help">?</button>
                      </div>
                      <div class="help">
                        Define layer-to-layer operations that update existing layers using array expressions (NumPy-style). These are stored inside gridstate.json and executed by a Python script.
                        Example: <span class="mono">target=cell</span> expr <span class="mono">cell - death</span> or <span class="mono">where(cell==1, atp + glucose*atp_maker*damage, atp)</span>.
                      </div>

                      <div class="row">
                        <label class="label">Insert layer</label>
                        <div class="two two--btn">
                          <select id="opsInsertLayer" class="input"></select>
                          <button id="opsInsertLayerBtn" class="btn btn--secondary">Insert</button>
                        </div>
                      </div>

                      <div class="row">
                        <label class="label">Insert function</label>
                        <div class="two two--btn">
                          <select id="opsInsertFn" class="input"></select>
                          <button id="opsInsertFnBtn" class="btn btn--secondary">Insert</button>
                        </div>
                      </div>

                      <div class="hr"></div>

                      <div class="opsToolbar">
                        <div class="opsToolbar__row">
                          <button id="opsAddRowBtn" class="btn btn--secondary">Add operation</button>
                          <button id="opsAddVarBtn" class="btn btn--secondary">Add variable</button>
                          <button id="opsAddForEachBtn" class="btn btn--secondary">Add foreach</button>
                          <button id="opsAddTransportBtn" class="btn btn--secondary">Add transport</button>
                          <button id="opsAddDiffusionBtn" class="btn btn--secondary">Add diffusion</button>
                          <button id="opsAddDivisionBtn" class="btn btn--secondary">Add division</button>
                          <button id="opsAddPathwayBtn" class="btn btn--secondary">Add pathway</button>
                        </div>
                      </div>

                      <div class="row">
                        <label class="label">Duplicate group</label>
                        <div class="opsDupGroup">
                          <select id="opsDupGroupFrom" class="input"></select>
                          <input id="opsDupGroupTo" class="input" placeholder="new group name (e.g. translation)" />
                          <button id="opsDupGroupBtn" class="btn btn--secondary">Duplicate</button>
                        </div>
                      </div>

                      <div class="row row--inline">
                        <div class="opsToolbar__row opsToolbar__row--secondary">
                          <button id="opsTestBtn" class="btn btn--secondary">Test operations</button>
                          <button id="opsResetBtn" class="btn btn--secondary">Clear</button>
                        </div>
                      </div>

                      <div class="row row--inline">
                        <div id="opsSpecsTable" class="table"></div>
                      </div>
                    </section>
                  </div>
                </div>
              </aside>
            </div>
          </div>

          <div class="screenPanel" data-screen="runtime">
            <div class="functionsLayout">
              <aside class="toolsDock toolsDock--full">
                <section class="panel">
                  <div class="panel__title">Runtime</div>
                  <div class="help">
                    Runtime always runs the current editor gridstate (auto-synced). Repeatedly apply Layer Ops (one step per tick) and visualize selected layers as live heatmaps.
                    This requires running the local runtime server.
                  </div>

                  <div class="row">
                    <label class="label">Tick interval (ms)</label>
                    <div class="two two--btn">
                      <input id="rtIntervalMs" class="input" type="number" min="50" step="50" value="500" />
                      <button id="rtStartStopBtn" class="btn btn--secondary">Start</button>
                    </div>
                  </div>

                  <div class="row row--inline">
                    <div class="three">
                      <button id="rtStepBtn" class="btn btn--secondary btn--tiny">Step once</button>
                      <button id="rtResetBtn" class="btn btn--secondary btn--tiny">Reset</button>
                      <button id="rtDownloadBtn" class="btn btn--secondary btn--tiny">Download tick</button>
                    </div>
                  </div>

                  <div class="row row--inline">
                    <div id="rtStatus" class="meta"></div>
                  </div>

                  <div class="hr"></div>

                  <div class="runtimeDash">
                    <div class="runtimeDash__left">
                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Events</div>
                        <div id="rtEventsList" class="runtimeEventsList"></div>
                      </div>

                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Layer scalars</div>
                        <div class="runtimeBlock__controls">
                          <label class="meta">Window (ticks)</label>
                          <input id="rtScalarsWindow" class="input input--tiny" type="number" min="10" step="10" value="200" />
                          <label class="checkbox"><input id="rtScalarsLog" type="checkbox" /> Log</label>
                        </div>
                        <div id="rtScalarsList" class="runtimeScalarsList"></div>
                      </div>

                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Measurements</div>
                        <div class="runtimeBlock__controls">
                          <label class="meta">Window (ticks)</label>
                          <input id="rtMeasWindow" class="input input--tiny" type="number" min="10" step="10" value="300" />
                          <label class="checkbox"><input id="rtMeasNormalize" type="checkbox" checked /> Normalize</label>
                          <label class="checkbox"><input id="rtMeasLog" type="checkbox" /> Log</label>
                        </div>
                        <div class="runtimeMeasWrap">
                          <canvas id="rtMeasCanvas" class="runtimeMeasCanvas"></canvas>
                        </div>
                        <div id="rtMeasList" class="runtimeMeasList"></div>
                      </div>

                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Survival @ t=0</div>
                        <div class="runtimeBlock__controls">
                          <label class="meta">Focus</label>
                          <select id="rtSurvFocus" class="input input--tiny">
                            <option value="gene">gene_*</option>
                            <option value="protein">protein_*</option>
                            <option value="rna">rna_*</option>
                            <option value="molecule">molecule_*</option>
                            <option value="damage">damage*</option>
                            <option value="all">all</option>
                          </select>
                          <label class="meta">Top</label>
                          <input id="rtSurvTopK" class="input input--tiny" type="number" min="5" step="5" value="12" />
                          <label class="checkbox"><input id="rtSurvLog1p" type="checkbox" checked /> log1p</label>
                        </div>
                        <div id="rtSurvList" class="runtimeSurvList"></div>
                      </div>
                    </div>

                    <div class="runtimeDash__right">
                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Watch layers</div>
                        <div class="runtimeBlock__controls">
                          <select id="rtAddLayerSelect" class="input"></select>
                          <button id="rtAddLayerBtn" class="btn btn--secondary btn--tiny">Add</button>
                        </div>
                        <div id="rtWatchList" class="runtimeWatchList"></div>
                      </div>

                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Overlay</div>
                        <div class="runtimeOverlayWrap">
                          <canvas id="rtOverlayCanvas" class="stepsCanvas"></canvas>
                        </div>
                      </div>

                      <div class="runtimeBlock">
                        <div class="runtimeBlock__title">Heatmaps</div>
                        <div class="runtimeBlock__controls">
                          <label class="meta">Columns</label>
                          <select id="rtVizCols" class="input input--tiny">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                          </select>
                          <label class="checkbox"><input id="rtHeatMaskEnabled" type="checkbox" /> Mask heatmaps</label>
                        </div>
                        <div class="runtimeHeatmapsWrap">
                          <div class="runtimeHeatmapsWrap__left">
                            <div class="runtimeHistControls">
                              <label class="meta">Layer</label>
                              <select id="rtHistLayer" class="input input--tiny"></select>
                              <label class="meta">Bins</label>
                              <input id="rtHistBins" class="input input--tiny" type="number" min="10" step="10" value="60" />
                              <label class="checkbox"><input id="rtHistLogY" type="checkbox" /> Log Y</label>
                              <div class="hr" style="margin: 8px 0;"></div>
                              <label class="meta">Mask</label>
                              <select id="rtHistMaskLayer" class="input input--tiny">
                                <option value="">(none)</option>
                              </select>
                              <select id="rtHistMaskOp" class="input input--tiny">
                                <option value="==">==</option>
                                <option value="!=">!=</option>
                                <option value=">">></option>
                                <option value=">=">>=</option>
                                <option value="<"><</option>
                                <option value="<="><=</option>
                              </select>
                              <input id="rtHistMaskValue" class="input input--tiny" type="number" step="any" value="1" />
                            </div>
                            <div class="runtimeHistWrap">
                              <canvas id="rtHistCanvas" class="runtimeHistCanvas"></canvas>
                            </div>
                          </div>
                          <div class="runtimeHeatmapsWrap__right">
                            <div id="rtVizGrid" class="runtimeVizGrid"></div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </aside>
            </div>
          </div>

          <div class="screenPanel" data-screen="evolution">
            <div class="evoLayout">
              <aside class="sidebar">
                <section class="panel">
                  <div class="panel__title">Evolution</div>
                  <div class="help">
                    Run evolutionary search over initial gene/rna/protein layers and select the best-performing candidates. Evolution runs use optimized layer ops.
                  </div>

                  <div class="row">
                    <label class="label" title="Which search method to use.\n\nCEM delta-field: samples additive deltas and learns where good solutions are. Good default.\nAffine GA: mutates scale/bias per layer (simpler, sometimes less expressive).">Algorithm</label>
                    <select id="evoAlgo" class="input">
                      <option value="cem_delta" selected>CEM delta-field</option>
                      <option value="affine">Affine GA (scale/bias)</option>
                      <option value="auto_switch">Auto switch (plateau)</option>
                    </select>
                  </div>

                  <div id="evoAutoParams">
                    <div class="row">
                      <label class="label">Auto: start with</label>
                      <select id="evoAutoFirst" class="input">
                        <option value="cem_delta" selected>CEM delta-field</option>
                        <option value="affine">Affine GA (scale/bias)</option>
                      </select>
                    </div>
                    <div class="row">
                      <label class="label" title="If the best fitness does not improve for this many completed generations, auto-switch to the other algorithm.">Auto: plateau patience (generations)</label>
                      <input id="evoAutoPatience" class="input" type="number" min="1" step="1" value="5" />
                    </div>
                    <div class="row">
                      <label class="label" title="Minimum % improvement in best fitness over the patience window that counts as progress (e.g. 5 means 5%).">Auto: min improvement (%)</label>
                      <input id="evoAutoMinDelta" class="input" type="number" step="any" value="0" />
                    </div>
                    <div class="row">
                      <label class="label" title="Maximum number of auto-switches before stopping auto mode.">Auto: max switches</label>
                      <input id="evoAutoMaxSwitches" class="input" type="number" min="0" step="1" value="20" />
                    </div>
                  </div>

                  <div class="row">
                    <label class="label" title="How many candidate solutions are evaluated each generation.\nHigher = more exploration and usually better results, but slower.\nTypical: 50–300.">Variants per generation</label>
                    <input id="evoVariants" class="input" type="number" min="1" step="1" value="75" />
                  </div>
                  <div class="row">
                    <label class="label" title="How long each candidate is simulated (number of ticks).\nHigher = more accurate/less noisy fitness, but slower.\nTypical: 30–200.">Ticks per evaluation</label>
                    <input id="evoTicks" class="input" type="number" min="1" step="1" value="100" />
                  </div>
                  <div class="row">
                    <label class="label" title="How many rounds of evolution to run.\nMore generations gives the optimizer more chances to improve, but costs time.\nTypical: 10–100.">Generations</label>
                    <input id="evoGenerations" class="input" type="number" min="1" step="1" value="50" />
                  </div>

                  <div class="row">
                    <label class="label" title="How many top candidates influence the next generation.\nSmaller = more greedy (can converge faster but risk getting stuck).\nLarger = more diverse (more stable, slower).\nTypical: 5–20.">Elites</label>
                    <input id="evoElites" class="input" type="number" min="1" step="1" value="5" />
                  </div>
                  <div class="row">
                    <label class="label" title="How many times to re-run each candidate and average the result.\nHigher = less random noise in fitness, but slower.\nTypical: 1–3.">Replicates</label>
                    <input id="evoReplicates" class="input" type="number" min="1" step="1" value="1" />
                  </div>

                  <div class="row">
                    <label class="label" title="How many candidates to evaluate in parallel.\nSet close to your CPU core count for speed. Too high can slow things down due to contention.\nTypical: 4–32 (machine dependent).">Workers</label>
                    <input id="evoWorkers" class="input" type="number" min="1" step="1" value="35" />
                  </div>

                  <div class="row">
                    <label class="label" title="Random seed for evolution. Change to get a different search trajectory when you rerun.">Seed</label>
                    <input id="evoSeed" class="input" type="number" step="1" value="1" />
                  </div>

                  <div class="hr"></div>

                  <div id="evoAffineParams">
                    <div class="row">
                      <label class="label" title="(Affine GA) Probability of mutating each layer's parameters per generation.\nHigher = explores more but can destabilize.\nTypical: 0.05–0.30.">Mutation rate</label>
                      <input id="evoMutationRate" class="input" type="number" min="0" max="1" step="0.01" value="0.15" />
                    </div>
                    <div class="row">
                      <label class="label" title="(Affine GA) Randomness of multiplicative scale mutations.\nHigher = bigger multiplicative jumps.\nTypical: 0.05–0.50. If fitness is erratic, reduce.">Scale sigma</label>
                      <input id="evoSigmaScale" class="input" type="number" min="0" step="0.01" value="0.25" />
                    </div>
                    <div class="row">
                      <label class="label" title="(Affine GA) Randomness of additive bias mutations.\nHigher = bigger additive jumps.\nTypical: 0.05–0.50. If candidates crash early, reduce.">Bias sigma</label>
                      <input id="evoSigmaBias" class="input" type="number" min="0" step="0.01" value="0.25" />
                    </div>
                  </div>

                  <div id="evoCemParams">
                    <div class="row">
                      <label class="label" title="(CEM) Initial search step size (how big random deltas are at the start).\nHigher = explores farther but can destroy good starting behavior.\nTypical: 0.05–0.50. If you see a huge early fitness drop, reduce.">CEM delta sigma (init)</label>
                      <input id="evoCemSigma" class="input" type="number" min="0" step="0.01" value="0.50" />
                    </div>
                    <div class="row">
                      <label class="label" title="(CEM) Learning rate for updating the search distribution (mu/sigma).\nHigher = adapts faster but can be unstable.\nTypical: 0.3–0.8.">CEM alpha</label>
                      <input id="evoCemAlpha" class="input" type="number" min="0" max="1" step="0.01" value="0.70" />
                    </div>
                    <div class="row">
                      <label class="label" title="(CEM) Minimum allowed sigma (step size).\nPrevents the search from collapsing too early.\nHigher = keeps exploring; lower = can converge tightly.\nTypical: 0.01–0.10.">CEM sigma floor</label>
                      <input id="evoCemSigmaFloor" class="input" type="number" min="0" step="0.01" value="0.05" />
                    </div>
                    <div class="row">
                      <label class="label" title="(CEM) Where mutations are allowed.\nOnly initial cells: edits only the starting organism footprint (safer).\nAll grid cells: can change the whole field (more powerful, riskier).">CEM delta mask</label>
                      <select id="evoCemMask" class="input">
                        <option value="cell" selected>Only initial cells</option>
                        <option value="all">All grid cells</option>
                      </select>
                    </div>
                  </div>
                  <div class="row">
                    <label class="label" title="Clamps all evolved float layers into [0, Huge] to avoid infinities/blow-ups.\nLeave large unless you want stricter caps. Smaller values can prevent runaway growth but may also limit behavior.">Huge (upper bound)</label>
                    <input id="evoHuge" class="input" type="number" min="1" step="1" value="1000000000" />
                  </div>

                  <div class="hr"></div>

                  <details class="details" open>
                    <summary class="details__summary">Target Layers (evolvable)</summary>
                    <div class="meta" style="margin: 8px 0; line-height: 1.4;">
                      Select which layers can be mutated during evolution. Use wildcards (e.g., <code>gene_*</code>) or select individual layers.
                    </div>
                    <div class="row row--inlineFlex" style="margin: 6px 0;">
                      <input id="evoTargetFilter" class="input input--tiny" placeholder="Search layers…" style="flex: 1;" />
                    </div>
                    <div class="row row--inlineFlex" style="margin: 6px 0; flex-wrap: wrap; gap: 4px;">
                      <button id="evoTargetAddGene" class="btn btn--secondary btn--tiny">+ gene_*</button>
                      <button id="evoTargetAddRna" class="btn btn--secondary btn--tiny">+ rna_*</button>
                      <button id="evoTargetAddProtein" class="btn btn--secondary btn--tiny">+ protein_*</button>
                      <button id="evoTargetAddMolecule" class="btn btn--secondary btn--tiny">+ molecule_*</button>
                      <button id="evoTargetClear" class="btn btn--danger btn--tiny">Clear</button>
                    </div>
                    <div class="row row--inlineFlex" style="margin: 6px 0;">
                      <input id="evoTargetCustomPattern" class="input input--tiny" placeholder="Custom pattern (e.g. damage_*)" style="flex: 1;" />
                      <button id="evoTargetAddCustom" class="btn btn--secondary btn--tiny">Add</button>
                    </div>
                    <div id="evoTargetPatterns" class="meta" style="margin: 6px 0; padding: 6px; background: rgba(255,255,255,0.03); border-radius: 6px; min-height: 24px;"></div>
                    <div id="evoTargetInfo" class="meta" style="margin: 6px 0;"></div>
                    <div id="evoTargetList" class="evoTargetList" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; margin-top: 6px;"></div>
                  </details>

                  <div class="hr"></div>

                  <div class="row">
                    <label class="label" title="Fitness is a weighted sum of your measurements.\nSet a weight to 0 to ignore that measurement.\nPositive weights reward higher values; negative weights penalize them.">Fitness objectives</label>
                    <div>
                      <div class="meta" style="margin-bottom: 12px; line-height: 1.4;">
                        Evolution maximizes fitness by combining your measurements with weights.<br>
                        <strong>Formula:</strong> fitness = (weight₁ × measurement₁) + (weight₂ × measurement₂) + ...<br>
                        <strong>Positive weights</strong> reward higher values, <strong>negative weights</strong> penalize them.
                      </div>
                      <div id="evoMeasList" class="evoWeights"></div>
                    </div>
                  </div>

                  <div class="row row--inline">
                    <div class="two two--btn">
                      <button id="evoStartBtn" class="btn btn--secondary">Start</button>
                      <button id="evoStopBtn" class="btn btn--secondary">Stop</button>
                    </div>
                  </div>

                  <div class="row row--inline">
                    <div id="evoStatus" class="meta"></div>
                  </div>
                </section>
              </aside>

              <aside class="toolsDock toolsDock--full">
                <section class="panel">
                  <div class="panel__title">Progress</div>
                  <div class="evoPlotWrap">
                    <canvas id="evoCanvas" class="evoCanvas"></canvas>
                    <canvas id="evoImpCanvas" class="evoImpCanvas"></canvas>
                  </div>
                  <div class="hr"></div>
                  <div class="panel__title">Top candidates</div>
                  <div id="evoTopList" class="table"></div>
                </section>
              </aside>
            </div>
          </div>
        </div>
      </div>

      <div id="helpModal" class="modal" aria-hidden="true">
        <div id="helpModalOverlay" class="modal__overlay"></div>
        <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
          <div class="modal__header">
            <div id="helpModalTitle" class="modal__title">Help</div>
            <button id="helpModalClose" class="btn btn--secondary btn--tiny" type="button">Close</button>
          </div>
          <div id="helpModalBody" class="modal__body"></div>
        </div>
      </div>

      <div id="pathwayModal" class="modal" aria-hidden="true">
        <div id="pathwayModalOverlay" class="modal__overlay"></div>
        <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="pathwayModalTitle" style="max-width: 640px;">
          <div class="modal__header">
            <div id="pathwayModalTitle" class="modal__title">Create Pathway</div>
            <button id="pathwayModalClose" class="btn btn--secondary btn--tiny" type="button">Cancel</button>
          </div>
          <div class="modal__body">
            <div class="pathwayForm">
              <div class="pathwayForm__field">
                <label class="label" for="pathwayName">Pathway Name</label>
                <input id="pathwayName" class="input" type="text" placeholder="e.g., glycolysis" value="glycolysis" />
                <div class="help">A unique identifier for this metabolic pathway</div>
              </div>

              <div class="pathwayForm__field">
                <label class="label" for="pathwayNumEnzymes">Number of Enzyme Steps</label>
                <input id="pathwayNumEnzymes" class="input" type="number" min="1" max="10" value="3" />
                <div class="help">Each enzyme can process signals from inputs or previous enzymes</div>
              </div>

              <div class="pathwayForm__field">
                <label class="label">Input Layers (consumed)</label>
                <div id="pathwayInputsContainer" class="pathwayForm__multiSelect">
                  <div class="pathwayForm__selectedItems" id="pathwayInputsSelected"></div>
                  <div id="pathwayInputsDropdown"></div>
                </div>
                <div class="help">Layers that will be consumed by this pathway</div>
              </div>

              <div class="pathwayForm__field">
                <label class="label">Output Layers (produced)</label>
                <div id="pathwayOutputsContainer" class="pathwayForm__multiSelect">
                  <div class="pathwayForm__selectedItems" id="pathwayOutputsSelected"></div>
                  <div id="pathwayOutputsDropdown"></div>
                </div>
                <div class="help">Layers that will be produced by this pathway</div>
              </div>

              <div class="pathwayForm__field">
                <label class="label" for="pathwayCellLayer">Cell Layer</label>
                <div id="pathwayCellLayer"></div>
                <div class="help">Pathway only operates where this layer equals the cell value</div>
              </div>

              <div class="pathwayForm__field">
                <label class="label" for="pathwayCellValue">Cell Value</label>
                <input id="pathwayCellValue" class="input" type="number" value="1" />
                <div class="help">Value that indicates a cell is present</div>
              </div>

              <div class="pathwayForm__field">
                <label class="label" for="pathwayEfficiency">Efficiency</label>
                <input id="pathwayEfficiency" class="input" type="number" min="0" step="0.1" value="1.0" />
                <div class="help">Multiplicative gain applied to output signal (higher = more production)</div>
              </div>

              <div class="pathwayForm__actions">
                <button id="pathwayModalCreate" class="btn btn--primary">Create Pathway</button>
                <button id="pathwayModalCancel" class="btn btn--secondary">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="app.js?v=div15"></script>
  </body>
</html>
